# n8n - Webhook N8N (Orquestração de Leads)

**route.ts**: Webhook POST principal que recebe eventos do N8N. Rate limiting: 100 req/min por IP. Validação: header 'x-webhook-secret' contra N8N_WEBHOOK_SECRET. Eventos suportados: 'leads-extracted' (delega para handleLeadsExtracted), 'lead-enriched' (email-only, valida com LeadEnrichedEmailSchema Zod, atualiza lead + cria 3 Email records PENDING), 'lead-enriched-whatsapp' (whatsapp-only, valida com LeadEnrichedWhatsAppSchema, cria 3 WhatsAppMessage records PENDING), 'lead-enriched-hybrid' (valida com LeadEnrichedHybridSchema, cria emails + whatsapp messages intercalados). Normaliza campos vazios com normalizeToNull. Usa transaction para atomicidade.

**handleLeadsExtracted.ts**: Handler auxiliar para evento 'leads-extracted'. Normaliza formato de leads (array, string JSON, objeto com .leads/.data/.items ou valores do objeto), valida cada lead (validateLeadData: precisa ter identificador - apifyId/placeId/title/nomeEmpresa), detecta duplicatas por apifyId OU placeId, calcula reembolso de duplicatas via calculateRefund (pricing-service), valida email com isValidEmail, normaliza campos, cria leads não-duplicados em batch (createMany), atualiza campanha com leadsRequested/leadsCreated/leadsDuplicated/creditsRefunded, reembolsa créditos ao usuário via transaction atômica. Retorna summary detalhado.
